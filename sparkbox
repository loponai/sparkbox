#!/usr/bin/env bash
# ==========================================
# SparkBox CLI
# Modular self-hosted privacy stack manager
# Created by Tom Spark | youtube.com/@TomSparkReviews
# ==========================================

set -euo pipefail

# --- Config ---
SB_ROOT="${SB_ROOT:-/opt/sparkbox}"
SB_STATE_DIR="${SB_ROOT}/state"
SB_MODULES_DIR="${SB_ROOT}/modules"
SB_MODULES_CONF="${SB_STATE_DIR}/modules.conf"
SB_ENV_FILE="${SB_ROOT}/.env"
SB_BACKUP_DIR="${SB_ROOT}/backups"
SB_VERSION="1.0.0"

# Core modules that are always active
CORE_MODULES="core dashboard"
# All available optional modules
AVAILABLE_MODULES="privacy cloud monitoring vpn files"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# --- Helpers ---

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

banner() {
    echo -e "${CYAN}"
    echo "  ____                   _    ____            "
    echo " / ___| _ __   __ _ _ __| | _| __ )  _____  __"
    echo " \\___ \\| '_ \\ / _\` | '__| |/ /  _ \\ / _ \\ \\/ /"
    echo "  ___) | |_) | (_| | |  |   <| |_) | (_) >  < "
    echo " |____/| .__/ \\__,_|_|  |_|\\_\\____/ \\___/_/\\_\\"
    echo "       |_|                                     "
    echo -e "${NC}"
    echo -e " ${BOLD}SparkBox${NC} v${SB_VERSION} - Self-Hosted Privacy Stack"
    echo -e " Created by Tom Spark | youtube.com/@TomSparkReviews"
    echo ""
}

ensure_state_dir() {
    mkdir -p "${SB_STATE_DIR}"
    if [[ ! -f "${SB_MODULES_CONF}" ]]; then
        # Default: only core modules
        echo "core" > "${SB_MODULES_CONF}"
        echo "dashboard" >> "${SB_MODULES_CONF}"
    fi
}

get_enabled_modules() {
    ensure_state_dir
    cat "${SB_MODULES_CONF}" 2>/dev/null | sort -u
}

is_module_enabled() {
    local module="$1"
    grep -qx "${module}" "${SB_MODULES_CONF}" 2>/dev/null
}

is_core_module() {
    local module="$1"
    [[ " ${CORE_MODULES} " == *" ${module} "* ]]
}

is_valid_module() {
    local module="$1"
    [[ " ${CORE_MODULES} ${AVAILABLE_MODULES} " == *" ${module} "* ]]
}

get_compose_args() {
    local args=""
    local project_name="sparkbox"

    for module in $(get_enabled_modules); do
        local compose_file="${SB_MODULES_DIR}/${module}/docker-compose.yml"
        if [[ -f "${compose_file}" ]]; then
            args="${args} -f ${compose_file}"
        else
            log_warn "Compose file not found for module: ${module}"
        fi
    done

    echo "-p ${project_name} ${args}"
}

# Safely load .env file for CLI variable access (handles spaces in values)
load_env() {
    if [[ -f "${SB_ENV_FILE}" ]]; then
        while IFS= read -r line; do
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
            export "$line"
        done < "${SB_ENV_FILE}"
    fi
}

run_compose() {
    local compose_args
    compose_args=$(get_compose_args)

    if [[ -f "${SB_ENV_FILE}" ]]; then
        # shellcheck disable=SC2086
        docker compose --env-file "${SB_ENV_FILE}" ${compose_args} "$@"
    else
        # shellcheck disable=SC2086
        docker compose ${compose_args} "$@"
    fi
}

# --- Commands ---

cmd_up() {
    banner
    log_info "Starting SparkBox..."
    log_info "Active modules: $(get_enabled_modules | tr '\n' ' ')"
    echo ""
    run_compose up -d "$@"
    echo ""
    log_ok "SparkBox is running!"
    echo ""
    cmd_urls
}

cmd_down() {
    log_info "Stopping SparkBox..."
    run_compose down "$@"
    log_ok "SparkBox stopped."
}

cmd_status() {
    banner
    echo -e "${BOLD}Module Status:${NC}"
    echo ""

    for module in ${CORE_MODULES} ${AVAILABLE_MODULES}; do
        if is_module_enabled "${module}"; then
            echo -e "  ${GREEN}●${NC} ${BOLD}${module}${NC} (enabled)"
        else
            echo -e "  ${RED}○${NC} ${module} (disabled)"
        fi
    done

    echo ""
    echo -e "${BOLD}Container Status:${NC}"
    echo ""
    docker ps --filter "name=sb-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || \
        log_warn "Could not query Docker. Is Docker running?"
}

cmd_modules() {
    banner
    echo -e "${BOLD}Available Modules:${NC}"
    echo ""

    echo -e "  ${BOLD}Always Active:${NC}"
    for module in ${CORE_MODULES}; do
        local desc=""
        case "${module}" in
            core)      desc="Nginx Proxy Manager + Portainer + Homepage" ;;
            dashboard) desc="SparkBox Web Dashboard" ;;
        esac
        echo -e "    ${GREEN}●${NC} ${BOLD}${module}${NC} - ${desc}"
    done

    echo ""
    echo -e "  ${BOLD}Optional:${NC}"
    for module in ${AVAILABLE_MODULES}; do
        local desc=""
        case "${module}" in
            privacy)    desc="Pi-hole + Vaultwarden + Authelia (DNS, passwords, SSO)" ;;
            cloud)      desc="Nextcloud + MariaDB + Redis (file sync)" ;;
            monitoring) desc="Uptime Kuma (service monitoring)" ;;
            vpn)        desc="WireGuard (remote access VPN)" ;;
            files)      desc="FileBrowser (web-based file manager)" ;;
        esac

        if is_module_enabled "${module}"; then
            echo -e "    ${GREEN}●${NC} ${BOLD}${module}${NC} - ${desc}"
        else
            echo -e "    ${RED}○${NC} ${module} - ${desc}"
        fi
    done
    echo ""
}

cmd_enable() {
    local module="${1:-}"
    if [[ -z "${module}" ]]; then
        log_error "Usage: sparkbox enable <module>"
        echo "Available modules: ${AVAILABLE_MODULES}"
        exit 1
    fi

    if ! is_valid_module "${module}"; then
        log_error "Unknown module: ${module}"
        echo "Available modules: ${AVAILABLE_MODULES}"
        exit 1
    fi

    if is_core_module "${module}"; then
        log_warn "${module} is a core module and is always enabled."
        return
    fi

    if is_module_enabled "${module}"; then
        log_warn "${module} is already enabled."
        return
    fi

    ensure_state_dir
    echo "${module}" >> "${SB_MODULES_CONF}"
    log_ok "Module '${module}' enabled."
    log_info "Run 'sparkbox up' to start the new module."
}

cmd_disable() {
    local module="${1:-}"
    if [[ -z "${module}" ]]; then
        log_error "Usage: sparkbox disable <module>"
        exit 1
    fi

    if is_core_module "${module}"; then
        log_error "Cannot disable core module: ${module}"
        exit 1
    fi

    if ! is_module_enabled "${module}"; then
        log_warn "${module} is not enabled."
        return
    fi

    # Stop the module's containers first
    local compose_file="${SB_MODULES_DIR}/${module}/docker-compose.yml"
    if [[ -f "${compose_file}" ]]; then
        log_info "Stopping ${module} containers..."
        if [[ -f "${SB_ENV_FILE}" ]]; then
            docker compose --env-file "${SB_ENV_FILE}" -p sparkbox -f "${compose_file}" down 2>/dev/null || true
        else
            docker compose -p sparkbox -f "${compose_file}" down 2>/dev/null || true
        fi
    fi

    # Remove from modules.conf
    local tmp
    tmp=$(mktemp)
    grep -vx "${module}" "${SB_MODULES_CONF}" > "${tmp}" || true
    mv "${tmp}" "${SB_MODULES_CONF}"

    log_ok "Module '${module}' disabled."
}

cmd_restart() {
    local module="${1:-}"

    if [[ -z "${module}" ]]; then
        log_info "Restarting all SparkBox services..."
        run_compose restart
    else
        if ! is_valid_module "${module}"; then
            log_error "Unknown module: ${module}"
            exit 1
        fi

        local compose_file="${SB_MODULES_DIR}/${module}/docker-compose.yml"
        if [[ -f "${compose_file}" ]]; then
            log_info "Restarting module: ${module}"
            if [[ -f "${SB_ENV_FILE}" ]]; then
                docker compose --env-file "${SB_ENV_FILE}" -p sparkbox -f "${compose_file}" restart
            else
                docker compose -p sparkbox -f "${compose_file}" restart
            fi
        fi
    fi

    log_ok "Restart complete."
}

cmd_update() {
    local module="${1:-}"

    if [[ -z "${module}" ]]; then
        log_info "Pulling latest images for all enabled modules..."
        run_compose pull
        log_info "Recreating containers..."
        run_compose up -d --force-recreate
    else
        if ! is_valid_module "${module}"; then
            log_error "Unknown module: ${module}"
            exit 1
        fi

        local compose_file="${SB_MODULES_DIR}/${module}/docker-compose.yml"
        if [[ -f "${compose_file}" ]]; then
            log_info "Updating module: ${module}"
            if [[ -f "${SB_ENV_FILE}" ]]; then
                docker compose --env-file "${SB_ENV_FILE}" -p sparkbox -f "${compose_file}" pull
                docker compose --env-file "${SB_ENV_FILE}" -p sparkbox -f "${compose_file}" up -d --force-recreate
            else
                docker compose -p sparkbox -f "${compose_file}" pull
                docker compose -p sparkbox -f "${compose_file}" up -d --force-recreate
            fi
        fi
    fi

    log_ok "Update complete."
}

cmd_logs() {
    local service="${1:-}"

    if [[ -z "${service}" ]]; then
        log_error "Usage: sparkbox logs <service>"
        echo "Examples: sparkbox logs sb-pihole"
        exit 1
    fi

    docker logs -f --tail 100 "${service}"
}

cmd_backup() {
    local timestamp
    timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="${SB_BACKUP_DIR}/sparkbox-backup-${timestamp}.tar.gz"

    mkdir -p "${SB_BACKUP_DIR}"

    log_info "Creating backup..."
    log_info "This may take a while depending on data size."

    # Backup state, env, and all module configs (not media data)
    tar -czf "${backup_file}" \
        -C "${SB_ROOT}" \
        state \
        .env \
        modules/*/config 2>/dev/null || true

    if [[ -f "${backup_file}" ]]; then
        local size
        size=$(du -h "${backup_file}" | cut -f1)
        log_ok "Backup created: ${backup_file} (${size})"
    else
        log_error "Backup failed."
        exit 1
    fi
}

cmd_restore() {
    local backup_file="${1:-}"

    if [[ -z "${backup_file}" ]]; then
        log_error "Usage: sparkbox restore <backup-file>"
        if [[ -d "${SB_BACKUP_DIR}" ]]; then
            echo ""
            echo "Available backups:"
            ls -lh "${SB_BACKUP_DIR}"/sparkbox-backup-*.tar.gz 2>/dev/null || echo "  No backups found."
        fi
        exit 1
    fi

    if [[ ! -f "${backup_file}" ]]; then
        log_error "Backup file not found: ${backup_file}"
        exit 1
    fi

    log_warn "This will overwrite current configuration!"
    read -rp "Continue? [y/N] " confirm
    if [[ "${confirm}" != "y" && "${confirm}" != "Y" ]]; then
        log_info "Restore cancelled."
        exit 0
    fi

    log_info "Stopping SparkBox..."
    run_compose down 2>/dev/null || true

    log_info "Restoring from backup..."
    tar -xzf "${backup_file}" -C "${SB_ROOT}"

    log_ok "Restore complete. Run 'sparkbox up' to start."
}

cmd_config() {
    if [[ -f "${SB_ROOT}/scripts/setup.sh" ]]; then
        bash "${SB_ROOT}/scripts/setup.sh"
    else
        log_error "Setup script not found. Please reinstall SparkBox."
        exit 1
    fi
}

cmd_urls() {
    load_env
    echo -e "${BOLD}Service URLs:${NC}"
    echo ""

    local domain="${SB_DOMAIN:-localhost}"

    # Core - always shown
    echo -e "  ${BOLD}Core:${NC}"
    echo "    NPM Admin:     http://${domain}:81"
    echo "    Portainer:      http://${domain}:9000"
    echo "    Homepage:       http://${domain}:3000"
    echo "    Dashboard:      http://${domain}:8443"

    if is_module_enabled "privacy"; then
        echo ""
        echo -e "  ${BOLD}Privacy:${NC}"
        echo "    Pi-hole:        http://${domain}:8053/admin"
        echo "    Vaultwarden:    http://${domain}:8222"
        echo "    Authelia:       http://${domain}:9091"
    fi

    if is_module_enabled "cloud"; then
        echo ""
        echo -e "  ${BOLD}Cloud:${NC}"
        echo "    Nextcloud:      https://${domain}:8443"
    fi

    if is_module_enabled "monitoring"; then
        echo ""
        echo -e "  ${BOLD}Monitoring:${NC}"
        echo "    Uptime Kuma:    http://${domain}:3001"
    fi

    if is_module_enabled "vpn"; then
        echo ""
        echo -e "  ${BOLD}VPN:${NC}"
        echo "    wg-easy:        http://${domain}:51821"
    fi

    if is_module_enabled "files"; then
        echo ""
        echo -e "  ${BOLD}Files:${NC}"
        echo "    FileBrowser:    http://${domain}:8086"
    fi

    echo ""
}

cmd_install() {
    if [[ -f "${SB_ROOT}/scripts/setup.sh" ]]; then
        banner
        bash "${SB_ROOT}/scripts/setup.sh"
    else
        log_error "Setup script not found."
        exit 1
    fi
}

cmd_help() {
    banner
    echo -e "${BOLD}Usage:${NC} sparkbox <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  install              Run initial setup wizard"
    echo "  up                   Start all enabled modules"
    echo "  down                 Stop everything"
    echo "  status               Show all service statuses"
    echo "  modules              List available/enabled modules"
    echo "  enable <module>      Enable and configure a module"
    echo "  disable <module>     Stop and disable a module"
    echo "  restart [module]     Restart all or one module"
    echo "  update [module]      Pull latest images, recreate containers"
    echo "  logs <service>       Tail container logs"
    echo "  backup               Create backup archive"
    echo "  restore <file>       Restore from backup"
    echo "  config               Re-run configuration wizard"
    echo "  urls                 Show service URLs"
    echo "  help                 Show this help"
    echo ""
    echo -e "${BOLD}Modules:${NC}"
    echo "  core         Nginx Proxy Manager + Portainer + Homepage (always on)"
    echo "  dashboard    SparkBox Web Dashboard (always on)"
    echo "  privacy      Pi-hole + Vaultwarden + Authelia"
    echo "  cloud        Nextcloud + MariaDB + Redis"
    echo "  monitoring   Uptime Kuma"
    echo "  vpn          WireGuard (wg-easy)"
    echo "  files        FileBrowser (web-based file manager)"
    echo ""
}

# --- Main ---

main() {
    local command="${1:-help}"
    shift 2>/dev/null || true

    case "${command}" in
        install)  cmd_install "$@" ;;
        up)       cmd_up "$@" ;;
        down)     cmd_down "$@" ;;
        status)   cmd_status "$@" ;;
        modules)  cmd_modules "$@" ;;
        enable)   cmd_enable "$@" ;;
        disable)  cmd_disable "$@" ;;
        restart)  cmd_restart "$@" ;;
        update)   cmd_update "$@" ;;
        logs)     cmd_logs "$@" ;;
        backup)   cmd_backup "$@" ;;
        restore)  cmd_restore "$@" ;;
        config)   cmd_config "$@" ;;
        urls)     cmd_urls "$@" ;;
        help|--help|-h)
                  cmd_help ;;
        version|--version|-v)
                  echo "SparkBox v${SB_VERSION}" ;;
        *)
            log_error "Unknown command: ${command}"
            echo "Run 'sparkbox help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
